@page "/chitietsanpham/{ProductId:int}"
@using MilkTea.Core.ViewModels
@using MilkTea.Services.ProductServices
@using MilkTea.Services.ToppingServices
@using System.Text.Json
@inject NavigationManager NavigationManager
@inject IProductService ProductService
@inject IToppingService ToppingService
@inject IJSRuntime JSRuntime
@layout MainLayout
@rendermode InteractiveServer

<div class="container mt-5">
    @if (product == null)
    {
        <div class="text-center">
            <p class="fs-5">Đang tải thông tin sản phẩm...</p>
        </div>
    }
    else
    {
        <div class="card shadow-lg p-4">
            <div class="row">
                <!-- Hình ảnh sản phẩm -->
                <div class="col-md-5 text-center">
                    <img src="@product.ImageUrl" alt="@product.ProductName" class="img-fluid rounded product-image" />
                </div>

                <!-- Thông tin sản phẩm -->
                <div class="col-md-7">
                    <h2 class="fw-bold">@product.ProductName</h2>
                    <p class="text-muted">@product.Description</p>
                    <p class="fs-4 text-danger fw-bold">Giá: @product.PriceS.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("vi-VN")) VND</p>

                    <!-- Chọn size -->
                    <h5 class="mt-3">Chọn Size</h5>
                    <select @bind="selectedSize" class="form-select w-50">
                        @foreach (var size in sizes)
                        {
                            <option value="@size">@size</option>
                        }
                    </select>

                    <!-- Chọn topping -->
                    <h5 class="mt-4">Chọn Topping</h5>
                    <div class="topping-list">
                        @foreach (var topping in toppings)
                        {
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="topping-@topping.ToppingId" @bind="toppingSelection[topping.ToppingId]" />
                                <label class="form-check-label" for="topping-@topping.ToppingId">@topping.ToppingName</label>
                            </div>
                        }
                    </div>

                    <!-- Nút thêm vào giỏ -->
                    <button class="btn btn-primary mt-4 w-100 fw-bold" @onclick="AddToCart">
                        <i class="fas fa-cart-plus"></i> Thêm vào giỏ hàng
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int ProductId { get; set; }
    private ProductViewModel product;
    private List<string> sizes = new List<string> { "Small", "Medium", "Large" };
    private Dictionary<int, bool> toppingSelection = new Dictionary<int, bool>();
    private List<ToppingViewModel> toppings = new List<ToppingViewModel>();
    private string selectedSize = "Medium";

    protected override async Task OnInitializedAsync()
    {
        product = await ProductService.GetProductByIdAsync(ProductId);
        toppings = ToppingService.GetAllToppings();

        foreach (var topping in toppings)
        {
            toppingSelection[topping.ToppingId] = false;
        }
    }

    private async Task AddToCart()
    {
        if (product == null)
        {
            return;
        }

        var selectedToppings = toppingSelection
            .Where(t => t.Value)
            .Select(t => t.Key)
            .ToList();

        var cartItem = new OrderDetailViewModel
            {
                ProductId = product.ProductId,
                Size = selectedSize,
            };

        await JSRuntime.InvokeVoidAsync("setCookie", "Cart", JsonSerializer.Serialize(cartItem));
        NavigationManager.NavigateTo("/cart");
    }
}
